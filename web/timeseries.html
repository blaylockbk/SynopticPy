<!DOCTYPE html>
<html>
  <head>
    <!-- TODO: Add color pickers for custom color cycle: https://getbootstrap.com/docs/5.3/forms/form-control/#color -->
    <!-- TODO: Why isn't the pd.rolling working? -->
    <!-- TODO: pd.resample should align plot on right for minute, hour; but on left for day, month, week, year -->
    <!-- TODO: Add instructions in modal -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Multi-station Timeseries</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  </head>

  <body>
    <!-- prettier-ignore -->
    <py-config>
      packages = ["matplotlib", "pandas", "numpy"]
    </py-config>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
      crossorigin="anonymous"
    ></script>

    <h1 align="center">
      Multi-station Time Series
      <!-- Button trigger modal -->
      <button
        type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#exampleModal"
      >
        README
      </button>

      <!-- Modal -->
      <div
        class="modal fade"
        id="exampleModal"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel">
                Multi-station Timeseries Web App
              </h1>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              This gets data from the Synoptic Mesonet API, reads it with
              Pandas, and plots a timeseries of the data with matplotlib. This
              is all done in your browser powered by
              <a href="https://pyscript.net/">pyscript</a>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </h1>

    <div class="container">
      <hr />

      <div align="center" class="contentText form-group">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <!-- Station ID ----------------------->
            <div class="input-group mb-3">
              <span class="input-group-text" id="stid">Station IDs</span>
              <input
                type="text"
                id="stidInput"
                class="form-control"
                value="PSRIM,PSINK"
                title="Comma-separated list of MesoWest Station IDs"
              />
            </div>
          </div>
          <div class="col-sm-6">
            <!-- Variable ----------------------->
            <div class="input-group mb-3">
              <label class="input-group-text" for="variable">Variable</label>
              <select class="form-select" id="variableSelector">
                <option selected="selected" value="air_temp">
                  🌡️ Air Temperature
                </option>
                <option value="relative_humidity">💧 Relative Humidity</option>
                <option value="wind_speed">🍃 Wind Speed</option>
                <option value="wind_gust">🌬️ Wind Gust</option>
                <option value="wind_direction">🧭 Wind Direction</option>
                <!-- <option value="wind_direction,wind_speed">🏹 Wind Barbs</option> -->
                <!-- <option value="???">☔ Precipitation</option> -->
                <option value="dew_point_temperature">💦 Dew Point</option>
                <option value="pressure">🎈 Pressure</option>
                <option value="solar_radiation">☀️ Solar Radiation</option>
                <option value="PM_25_concentration">
                  🏭 PM 2.5 Concentration
                </option>
                <option value="ozone_concentration">
                  😎 Ozone Concentration
                </option>
              </select>
            </div>
          </div>
        </div>
        <div class="row align-items-center">
          <div class="col-sm-6">
            <!-- Duration ----------------------->
            <div class="input-group mb-3">
              <span class="input-group-text" id="duration">Duration</span>
              <input
                type="text"
                id="durationInput"
                class="form-control"
                value="12H"
                title="Pandas-parsable timedelta (e.g., 30min, 1H, 6H)"
              />
            </div>
          </div>
          <div class="col-sm-6">
            <!-- End Time ----------------------->
            <div class="input-group mb-3">
              <span class="input-group-text" id="endTime">Ending at</span>
              <input
                type="text"
                class="form-control"
                id="endTimeInput"
                placeholder="YYYY-MM-DD HH:MM"
                title="Pandas-parsable datetime (e.g., YYYY-MM-DD HH:MM)"
              />
            </div>
            <script>
              // Get the input element by ID
              var endTimeInput = document.getElementById("endTimeInput");

              // Create a new Date object with the current datetime
              var currentDate = new Date();

              // Format the datetime as YYYY-MM-DD HH:MM
              var formattedDatetime = currentDate
                .toISOString()
                .slice(0, 16)
                .replace("T", " ");

              // Set the formatted datetime as the value of the input element
              endTimeInput.value = formattedDatetime;
            </script>
          </div>
        </div>

        <!-- Smoother ----------------------->
        <div class="input-group mb-3">
          <label class="input-group-text" for="smoothing">Smoother</label>
          <select class="form-select" id="smootherSelector1">
            <option selected="selected" value="none">None</option>
            <option value="rolling">Rolling (doesn't seem to work)</option>
            <option value="resample">Resample</option>
          </select>
          <select class="form-select" id="smootherSelector2">
            <option selected="selected" value="none">None</option>
            <option value="mean">Mean</option>
            <option value="max">Max</option>
            <option value="min">Min</option>
          </select>
          <input
            type="text"
            id="smootherInput"
            class="form-control"
            value="30min"
            title="Pandas-parsable timedelta (e.g., 30min, 1H, 6H)"
          />
        </div>

        <!-- Units ----------------------->
        <div class="form-check form-check-inline">
          <input
            class="form-check-input"
            type="radio"
            name="unitsRadioOptions"
            id="unitsRadio1"
            value="english"
            checked
          />
          <label class="form-check-label" for="inlineRadio1"
            >English Units</label
          >
        </div>
        <div class="form-check form-check-inline">
          <input
            class="form-check-input"
            type="radio"
            name="unitsRadioOptions"
            id="unitsRadio2"
            value="metric"
          />
          <label class="form-check-label" for="inlineRadio2"
            >Metric Units</label
          >
        </div>

        <!-- Submit Button ----------------------------------------------------------->

        <div class="form-group" style="padding-top: 10px">
          <div class="col-sm-offset-5 col-sm-10">
            <button
              type="submit"
              class="btn btn-success"
              py-click="main()"
              id="display"
            >
              Make Plot
            </button>
          </div>
        </div>
      </div>
      <hr />

      <!-- CONTENT TABS  -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="home-tab"
            data-bs-toggle="tab"
            data-bs-target="#home-tab-pane"
            type="button"
            role="tab"
            aria-controls="home-tab-pane"
            aria-selected="true"
          >
            Figure
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="profile-tab"
            data-bs-toggle="tab"
            data-bs-target="#profile-tab-pane"
            type="button"
            role="tab"
            aria-controls="profile-tab-pane"
            aria-selected="false"
          >
            REPL
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link disabled"
            id="contact-tab"
            data-bs-toggle="tab"
            data-bs-target="#contact-tab-pane"
            type="button"
            role="tab"
            aria-controls="contact-tab-pane"
            aria-selected="false"
          >
            Output
          </button>
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <div
          class="tab-pane fade show active"
          id="home-tab-pane"
          role="tabpanel"
          aria-labelledby="home-tab"
          tabindex="0"
        >
          <div id="graph-area"></div>
        </div>
        <div
          class="tab-pane fade"
          id="profile-tab-pane"
          role="tabpanel"
          aria-labelledby="profile-tab"
          tabindex="0"
        >
          <div id="replOutput"></div>
          <!-- prettier-ignore -->
          <py-repl output="replOutput">
          hello = "Hello world!"
          hello
        </py-repl>
        </div>

        <div
          class="tab-pane fade"
          id="contact-tab-pane"
          role="tabpanel"
          aria-labelledby="contact-tab"
          tabindex="0"
        >
          <!-- I want to put this here, but text displays on one line  -->
          <!-- <py-terminal></py-terminal> -->
        </div>
      </div>

      <br /><br /><br />
      <py-terminal></py-terminal>
    </div>

    <!-- (CONTENT TABS)  -->

    <!-- prettier-ignore -->
    <py-script>
      import js
      from pyscript import Element
      import asyncio
      from pyodide.http import pyfetch
      import matplotlib as mpl
      import matplotlib.pyplot as plt
      import pandas as pd
      import numpy as np
      import sys

      print(f"Python version:", sys.version)
      print(f"imported matplotlib {mpl.__version__}")
      print(f"imported pandas {pd.__version__}")
      print(f"imported numpy {np.__version__}")

      # Change default date formatter
      plt.rcParams["date.autoformatter.day"] = "%b %d\n%H:%M"
      plt.rcParams["date.autoformatter.hour"] = "%b %d\n%H:%M"

      config = {
          "default": {
              "verbose": True,
              "hide_token": True,
              "rename_value_1": True,
              "rename_set_1": True,
              "token": "0bbe0e9fda7945a68951cc1bdebb2b0d",
          }
      }

      # Available API Services
      # https://developers.synopticdata.com/mesonet/v2/
      _service = {"auth", "networks", "networktypes", "variables", "qctypes"}
      _stations = {"metadata", "timeseries", "precipitation", "nearesttime", "latest"}
      _service.update(_stations)

      # Station Selector Parameters Set
      _stn_selector = {
          "stid",
          "country",
          "state",
          "country",
          "status",
          "nwszone",
          "nwsfirezone",
          "cwa",
          "gacc",
          "subgacc",
          "vars",
          "varsoperator",
          "network",
          "radius",
          "limit",
          "bbox",
          "fields",
      }


      # Rename "set_1" and "value_1" names is a convience I prefer.
      ## You can turn these off in your requests by setting `rename_set_1`
      ## and `rename_value_1` to False in your function call where applicable.
      def _rename_set_1(df):
          """
          Rename Variable Columns Names

          Remove the 'set_1' and 'set_1d' from column names
          Sets 2+ will retain their full names.
          The user should refer to SENSOR_VARIABLES to see which
          variables are derived

          """

          ## Get list of current column names
          dummy_columns = list(df.columns)

          # Remove '_set_1' and '_set_1d' from column name
          var_names = [
              "_".join(v.split("_")[:-2]) if "_set_1" in v else v for v in dummy_columns
          ]

          # Number of observations in each column
          obs_count = list(df.count())

          # Sometimes, set_1 and set_1d are both returned. In that
          # case, we need to determin which column has the most
          # observations and use that as the main variable. The set
          # with fewer data will retain the 'set_1' or 'set_1d' label.
          renames = {}
          for i, name in enumerate(var_names):
              # Determine all indices this variable type is located
              var_bool = [v.startswith(name + "_set_1") for v in dummy_columns]
              var_idx = np.where(var_bool)[0]

              if len(var_idx) == 1:
                  # This variable is only listed once. Rename with var_name
                  renames[dummy_columns[i]] = var_names[var_idx[0]]
              elif len(var_idx) > 1:
                  # This variable is listed more than once.
                  # Determine which set has the most non-NaN data and
                  # rename that column as var_name.
                  max_idx = var_idx[np.argmax([obs_count[i] for i in var_idx])]
                  if max_idx == i:
                      # If the current iteration matches the var_idx with
                      # the most data, rename the column without set number.
                      renames[dummy_columns[i]] = var_names[max_idx]
                  else:
                      # If the current iteration does not match the var_idx
                      # with the most data, then retain the original column
                      # name with the set number.
                      renames[dummy_columns[i]] = dummy_columns[i]
              else:
                  # This case should only occur during my testing.
                  renames[dummy_columns[i]] = dummy_columns[i]
          df.rename(columns=renames, inplace=True)
          df.attrs["RENAMED"] = renames
          return df


      async def request(
          url,
          method="GET",
          body=None,
          headers=None,
          **fetch_kwargs,
      ):
          """
          Async request function. Pass in Method and make sure to await!
          Parameters:
              url: str = URL to make request to
              method: str = {"GET", "POST", "PUT", "DELETE"} from `JavaScript` global fetch())
              body: str = body as json string. Example, body=json.dumps(my_dict)
              headers: dict[str, str] = header as dict, will be converted to string...
                  Example, headers=json.dumps({"Content-Type": "application/json"})
              fetch_kwargs: Any = any other keyword arguments to pass to `pyfetch` (will be passed to `fetch`)
          Return:
              response: pyodide.http.FetchResponse = use with .status or await.json(), etc.
          """
          kwargs = {
              "method": method,
              "mode": "cors",
          }  # CORS: https://en.wikipedia.org/wiki/Cross-origin_resource_sharing
          if body and method not in ["GET", "HEAD"]:
              kwargs["body"] = body
          if headers:
              kwargs["headers"] = headers
          kwargs.update(fetch_kwargs)

          response = await pyfetch(url, **kwargs)
          return response



      async def main():
          # Get input values
          stid = Element("stidInput").value.replace(" ", "").upper()
          duration = pd.to_timedelta(Element("durationInput").value)
          end = pd.to_datetime(Element("endTimeInput").value)
          start = end - duration
          variable = Element("variableSelector").value
          smooth_type = Element("smootherSelector1").value
          smooth_stat = Element("smootherSelector2").value
          smooth_time = Element("smootherInput").value
          for ele in js.document.getElementsByName("unitsRadioOptions"):
              if ele.checked:
                  units = ele.value
                  break

          # Write input values to page
          print("User Input")
          print(f" ├──{stid=}")
          print(f" ├──{duration=}")
          print(f" ├──{start=}")
          print(f" ├──{end=}")
          print(f" ├──{variable=}")
          print(f" ├──{units=}")
          print(f" ├──{smooth_type=}")
          print(f" ├──{smooth_stat=}")
          print(f" └──{smooth_time=}")


          token = "0bbe0e9fda7945a68951cc1bdebb2b0d"
          url = f"https://api.synopticdata.com/v2/stations/timeseries?start={start:%Y%m%d%H%M}&end={end:%Y%m%d%H%M}&stid={stid}&vars={variable}&units={units}&token={token}"

          print(f"Request URL: {url}")

          headers = {"Content-type": "application/json"}
          response = await request(
              url,
              method="GET",
              # headers=headers,
          )
          status = response.status
          json = await response.json()
          print(f"GET request=> status:{status}")
          print(f"GET request=> json:{json}")


          rename_set_1 = True
          data = json

          print(data)
          # Build a separate pandas.DataFrame for each station.
          Z = []
          for stn in data["STATION"]:
              obs = stn.pop("OBSERVATIONS")
              senvars = stn.pop("SENSOR_VARIABLES")

              # Turn Data into a DataFrame
              df = pd.DataFrame(obs).set_index("date_time")

              # Remaining data in dict will be returned as attribute
              df.attrs = stn

              # Convert datetime index string to datetime
              df.index = pd.to_datetime(df.index)

              # Sort Column order alphabetically
              df = df.reindex(columns=df.columns.sort_values())

              # Break wind into U and V components, if speed and direction are available
              if all(["wind_speed" in senvars, "wind_direction" in senvars]):
                  for i_spd, i_dir in zip(
                      senvars["wind_speed"].keys(), senvars["wind_direction"].keys()
                  ):
                      u, v = spddir_to_uv(obs[i_spd], obs[i_dir])
                      this_set = "_".join(i_spd.split("_")[-2:])
                      df[f"wind_u_{this_set}"] = u
                      df[f"wind_v_{this_set}"] = v
                      data["UNITS"]["wind_u"] = data["UNITS"]["wind_speed"]
                      data["UNITS"]["wind_v"] = data["UNITS"]["wind_speed"]

              if rename_set_1:
                  df = _rename_set_1(df)

              # Drop Row if all data is NaN/None
              df.dropna(how="all", inplace=True)

              # In the DataFrame attributes, Convert some strings to float/int
              # (i.e., ELEVATION, latitude, longitude) BUT NOT STID!
              for k, v in df.attrs.items():
                  if isinstance(v, str) and k not in ["STID"]:
                      try:
                          n = float(v)
                          if n.is_integer():
                              df.attrs[k] = int(n)
                          else:
                              df.attrs[k] = n
                      except:
                          pass

              if len(df.columns) != len(set(df.columns)):
                  warnings.warn("🤹🏼‍♂️ DataFrame contains duplicate column names.")

              # Rename lat/lon to lowercase to match CF convenctions
              df.attrs["latitude"] = df.attrs.pop("LATITUDE")
              df.attrs["longitude"] = df.attrs.pop("LONGITUDE")

              # Include other info
              for i in data.keys():
                  if i != "STATION":
                      df.attrs[i] = data[i]
              df.attrs["SENSOR_VARIABLES"] = senvars
              #df.attrs["params"] = params
              df.attrs["service"] = "stations_timeseries"

              Z.append(df)


          fig, ax = plt.subplots(figsize=[10,6])
          for df in Z:
              if smooth_type == 'rolling':
                print(f"Apply smoothing:{smooth_type=}; {smooth_stat=}; {smooth_time=}")
                if smooth_stat == 'max':
                  df = df.rolling(smooth_time).max()
                elif smooth_stat == 'min':
                  df = df.rolling(smooth_time).min()
                elif smooth_stat == 'mean':
                  df = df.rolling(smooth_time).mean()
              elif smooth_type == "resample":
                print(f"Apply smoothing:{smooth_type=}; {smooth_stat=}; {smooth_time=}")
                if smooth_stat == 'max':
                  df = df.resample(smooth_time, label='right').max()
                elif smooth_stat == 'min':
                  df = df.resample(smooth_time, label='right').min()
                elif smooth_stat == 'mean':
                  df = df.resample(smooth_time, label='right').mean()
              ax.plot(df.index, df[variable], marker='o', markersize=3, linestyle='-', label=df.attrs['STID'])

          ax.set_ylabel(f'{variable.upper()} ({df.attrs.get("UNITS").get(variable)})')
          ax.set_title(variable)
          ax.spines[['right', 'top', 'bottom']].set_visible(False)
          ax.legend()
          ax.grid(alpha=.35)
          plt.tight_layout()
          display(fig, target="graph-area", append=False)

      asyncio.ensure_future(main())


      #js.document.querySelector("img").setAttribute("style", "max-width:100%")

    </py-script>
    <style>
      img {
        max-width: 98%;
        align-items: center;
      }
    </style>
  </body>
</html>
