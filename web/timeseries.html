<!DOCTYPE html>
<html data-bs-theme="light">
  <head>
    <!-- TODO: pd.resample should align plot on right for minute, hour; but on left for day, month, week, year -->
    <!-- TODO: Add instructions in modal -->
    <!-- TODO: Add a "spread" option to the smoother, use "bar chart" to display -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Station Timeseries</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous"
    />
    <script
      src="https://kit.fontawesome.com/f6cc126dcc.js"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <style>
      .spaced-list li {
        margin-bottom: 10px; /* Increase the margin-bottom value to increase spacing */
      }
    </style>
  </head>

  <body>
    <!-- prettier-ignore -->
    <py-config>
      packages = ["matplotlib", "pandas", "numpy"]
    </py-config>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
      crossorigin="anonymous"
    ></script>

    <h1 align="center">
      Station Timeseries
      <!-- Button trigger modal -->
      <button
        type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#exampleModal"
      >
        README
      </button>

      <!-- Modal -->
      <div
        class="modal fade"
        id="exampleModal"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel">
                Brian Blaylock's Station Timeseries Web App
              </h1>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body" style="font-size: 15px; text-align: left">
              <p>
                This app gets data from the Synoptic Mesonet API, reads it with
                Pandas, and plots a timeseries of the data with matplotlib. This
                is all done in your browser powered by
                <a href="https://pyscript.net/">pyscript</a>. The primary use of
                this app is to plot a timeseries of data from multiple stations
                in a single plot.
              </p>
              <p>
                <strong>Station IDs:</strong> A comma-separated list of station
                IDs. If you don't know the ID of a station, you can search for a
                station on
                <a href="https://mesowest.utah.edu/" target="_blank">Mesowest</a
                >.
              </p>
              <p>
                <strong>Variable:</strong> Select the variable you wish to plot.
              </p>
              <p>
                <strong>Duration:</strong> Specify the length of time you want
                to plot. This must be a Pandas-parsable timedelta string. Here
                are a few examples: <kbd>30min</kbd> for 30 minutes,
                <kbd>12H</kbd> for 12 hours, <kbd>3D</kbd> for 3 days.
              </p>
              <p>
                <strong>End time (UTC):</strong>
                Specify the end time of the timeseries. This must be a
                Pandas-parsable datetime; it may be easiest to use the format
                <kbd>YYYY-MM-DD HH:MM</kbd>
              </p>
              <p>
                <strong>Smoother:</strong>
                You can "smooth" the data using two different methods built into
                Pandas:
              </p>

              <ol>
                <li>
                  Resample: Reduces the amount of data points to interval
                  selected. This is useful for showing the "daily maximum
                  temperature" for the time period.
                </li>
                <li>
                  Rolling: Returns the same amount of data points but value
                  (i.e. mean, max, min) is computed over a time window.
                </li>
              </ol>
              <p>
                Also specify the time window and the statistic to compute in the
                time window.
              </p>

              <p>
                <strong>Colors:</strong>
                You can specify the colors you want each line. Maybe you have
                lots of stations plotted, but want to highlight only one; you
                can make that station "red" and the others a shade of grey.
              </p>
              <p>
                <strong>Toggles:</strong>
                Toggle units to be returned in English or Metric units. Also
                toggle if time is local or UTC.
              </p>

              <div class="accordion" id="accordionExample">
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button
                      class="accordion-button collapsed"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseThree"
                      aria-expanded="false"
                      aria-controls="collapseThree"
                    >
                      Backdoor: Advanced Station Selector
                    </button>
                  </h2>
                  <div
                    id="collapseThree"
                    class="accordion-collapse collapse"
                    data-bs-parent="#accordionExample"
                  >
                    <div class="accordion-body">
                      <p>
                        With some knowledge of the Synoptic Mesonet API, you can
                        make more complex station queries. While the simple
                        method for selecting stations is to provide a list of
                        station IDs (e.g.
                        <kbd>PSRIM,PSINK</kbd>), you can instead provide
                        arguments using the
                        <a
                          target="_blank"
                          href="https://developers.synopticdata.com/mesonet/v2/stations/timeseries/"
                          >station selection parameter</a
                        >
                        to get many types of station combinations. For example:
                      </p>

                      <ul class="spaced-list">
                        <li>
                          <kbd>radius=wbb,5</kbd> All stations within a 5 mile
                          radius of WBB
                        </li>
                        <li>
                          <kbd>radius=wbb,5&limit=10</kbd> Ten stations nearest
                          WBB within a 5 mile radius.
                        </li>
                        <li>
                          <kbd>radius=WBB,5&limit=10&stid=!MTMET</kbd> Same as
                          above, but exclude the station MTMET.
                        </li>
                        <li>
                          <kbd>radius=WBB,20&network=153</kbd> Stations within
                          20 miles of WBB that belong to the "UUNET" network.
                          (See list of
                          <a
                            href="https://developers.synopticdata.com/about/station-providers/"
                            >network providers</a
                          >.)
                        </li>
                        <li>
                          <kbd>radius=KSLC,40&network=1,2&limit=8</kbd> Eight
                          stations within 40 miles of KSLC that belong to the
                          "ASOS/AWOS" and "RAWS" networks. (See list of
                          <a
                            href="https://developers.synopticdata.com/about/station-providers/"
                            >network providers</a
                          >.)
                        </li>
                        <li>
                          <kbd>radius=41.5,-120.25,20&limit=10</kbd> Ten
                          stations within 20 miles of the latitude/longitude
                          location.
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </h1>

    <div class="container">
      <hr />

      <div align="center" class="contentText form-group">
        <!-- FIRST ROW -->
        <div class="row align-items-center">
          <div class="col-sm-6">
            <!-- Station ID ----------------------->
            <div class="input-group mb-3">
              <span class="input-group-text" id="stid">Station IDs</span>
              <input
                type="text"
                id="stidInput"
                class="form-control"
                value="PSRIM,PSINK"
                title="Comma-separated list of MesoWest Station IDs"
              />
            </div>
          </div>
          <div class="col-sm-6">
            <!-- Variable ----------------------->
            <div class="input-group mb-3">
              <label class="input-group-text" for="variable">Variable</label>
              <select class="form-select" id="variableSelector">
                <option selected="selected" value="air_temp">
                  🌡️ Air Temperature
                </option>
                <option value="dew_point_temperature">💦 Dew Point</option>
                <option value="relative_humidity">💧 Relative Humidity</option>
                <option value="wind_speed">🍃 Wind Speed</option>
                <option value="wind_direction">🧭 Wind Direction</option>
                <option value="wind_gust">🌬️ Wind Gust</option>
                <option value="wind_direction,wind_speed" disabled>
                  🏹 Wind Barbs
                </option>
                <option value="precip_accum">☔ Precipitation (only precip_accu currently supported)</option>
                <option value="pressure">🎈 Pressure</option>
                <option value="sea_level_pressure">⛵ Sea Level Pressure</option>
                <option value="altimeter">🏔️ Altimiter</option>
                <option value="snow_depth">❄️ Snow Depth</option>
                <option value="solar_radiation">☀️ Solar Radiation</option>
                <option value="PM_25_concentration">
                  🏭 PM 2.5 Concentration
                </option>
                <option value="ozone_concentration">
                  😎 Ozone Concentration
                </option>
                <option value="volt">
                  🔋 Battery Voltage
                </option>
              </select>
            </div>
          </div>
        </div>
        <!-- SECOND ROW -->
        <div class="row align-items-center">
          <div class="col-sm-6">
            <!-- Duration ----------------------->
            <div class="input-group mb-3">
              <span class="input-group-text" id="duration">Duration</span>
              <input
                type="text"
                id="durationInput"
                class="form-control"
                value="18H"
                title="Pandas-parsable timedelta (e.g., 30min, 1H, 6H)"
              />
            </div>
          </div>
          <div class="col-sm-6">
            <!-- End Time ----------------------->
            <div class="input-group mb-3">
              <span class="input-group-text" id="endTime">End time (UTC)</span>
              <input
                type="text"
                class="form-control"
                id="endTimeInput"
                placeholder="YYYY-MM-DD HH:MM"
                title="Pandas-parsable datetime (e.g., YYYY-MM-DD HH:MM)"
              />
            </div>
            <script>
              // Get the input element by ID
              var endTimeInput = document.getElementById("endTimeInput");

              // Create a new Date object with the current datetime
              var currentDate = new Date();

              // Format the datetime as YYYY-MM-DD HH:MM
              var formattedDatetime = currentDate
                .toISOString()
                .slice(0, 16)
                .replace("T", " ");

              // Set the formatted datetime as the value of the input element
              endTimeInput.value = formattedDatetime;
            </script>
          </div>
        </div>

        <!-- FOURTH ROW -->
        <div class="row align-items-center">
          <div class="col-sm-6">
            <!-- Smoother ----------------------->
            <div class="input-group mb-3">
              <div class="input-group mb-3">
                <label class="input-group-text" for="smoothing">Smoother</label>
                <select class="form-select" id="smootherSelector1">
                  <option selected="selected" value="none">None</option>
                  <option value="resample">Resample</option>
                  <option value="rolling">Rolling</option>
                </select>
                <input
                  type="text"
                  id="smootherInput"
                  class="form-control"
                  value="30min"
                  title="Pandas-parsable timedelta (e.g., 30min, 1H, 6H)"
                />
                <select class="form-select" id="smootherSelector2">
                  <option selected="selected" value="none">None</option>
                  <option value="mean">Mean</option>
                  <option value="max">Max</option>
                  <option value="min">Min</option>
                  <option value="mean">Mean</option>
                  <option value="std">Standard Deviation</option>
                  <option value="var">Variance</option>
                  <option value="spread" disabled>Spread</option>
                </select>
              </div>
            </div>
          </div>
          <div class="col-sm-6">
            <!-- Colors ----------------------->
            <!-- prettier-ignore -->
            <div class="input-group mb-3">
              <label class="input-group-text" for="colorCycle"
                >Colors</label
              >
              <input type="color" class="form-control form-control-color" name="color" value="#0d6efd" title="Choose color" id="color1">
              <input type="color" class="form-control form-control-color" name="color" value="#dc3545" title="Choose color" id="color2">
              <input type="color" class="form-control form-control-color" name="color" value="#fd7e14" title="Choose color" id="color3">
              <input type="color" class="form-control form-control-color" name="color" value="#198754" title="Choose color" id="color4">
              <input type="color" class="form-control form-control-color" name="color" value="#0dcaf0" title="Choose color" id="color5">
              <input type="color" class="form-control form-control-color" name="color" value="#563d7c" title="Choose color" id="color6">
              <input type="color" class="form-control form-control-color" name="color" value="#ffc107" title="Choose color" id="color7">
              <input type="color" class="form-control form-control-color" name="color" value="#262626" title="Choose color" id="color8">
              <input type="color" class="form-control form-control-color" name="color" value="#6610f2" title="Choose color" id="color9">
              <input type="color" class="form-control form-control-color" name="color" value="#20c997" title="Choose color" id="color10">
              <input type="color" class="form-control form-control-color" name="color" value="#e83e8c" title="Choose color" id="color11">
              <input type="color" class="form-control form-control-color" name="color" value="#a64dff" title="Choose color" id="color12">
            </div>
          </div>
        </div>
        <!-- THIRD ROW -->
        <div class="row align-items-center">
          <!-- Units toggle----------------------->
          <div class="col-sm-3">
            <div class="input-group mb-3">
              <div class="btn-group" role="group" aria-label="Basic example">
                <input
                  type="radio"
                  class="btn-check"
                  name="unitsRadioOptions"
                  id="unitsRadio1"
                  autocomplete="off"
                  value="english"
                  checked
                />
                <label class="btn btn-outline-dark" for="unitsRadio1"
                  >English Units</label
                >
                <input
                  type="radio"
                  class="btn-check"
                  name="unitsRadioOptions"
                  id="unitsRadio2"
                  autocomplete="off"
                  value="metric"
                />
                <label class="btn btn-outline-dark" for="unitsRadio2"
                  >Metric Units</label
                >
              </div>
            </div>
          </div>
          <!-- (Units toggle) -->
          <!-- timezone toggle----------------------->
          <div class="col-sm-3">
            <div class="input-group mb-3">
              <div class="btn-group" role="group" aria-label="Basic example">
                <input
                  type="radio"
                  class="btn-check"
                  name="timezoneRadioOptions"
                  id="timezoneRadio1"
                  autocomplete="off"
                  value="local"
                  checked
                />
                <label class="btn btn-outline-dark" for="timezoneRadio1"
                  >Local Time</label
                >
                <input
                  type="radio"
                  class="btn-check"
                  name="timezoneRadioOptions"
                  id="timezoneRadio2"
                  autocomplete="off"
                  value="utc"
                />
                <label class="btn btn-outline-dark" for="timezoneRadio2"
                  >UTC Time</label
                >
              </div>
            </div>
          </div>
          <!-- (timezone toggle) -->
          <div class="col-sm-6">
            <!-- Submit Button -->
            <div class="form-group" style="padding-top: 10px">
              <div class="col-sm-4">
                <button
                  type="submit"
                  class="btn btn-success"
                  py-click="main()"
                  id="display"
                >
                  Make Plot
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <hr />

      <!-- CONTENT TABS  -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="home-tab"
            data-bs-toggle="tab"
            data-bs-target="#home-tab-pane"
            type="button"
            role="tab"
            aria-controls="home-tab-pane"
            aria-selected="true"
          >
            Figure
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="contact-tab"
            data-bs-toggle="tab"
            data-bs-target="#contact-tab-pane"
            type="button"
            role="tab"
            aria-controls="contact-tab-pane"
            aria-selected="false"
          >
            Station Info
          </button>
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <div
          class="tab-pane fade show active"
          id="home-tab-pane"
          role="tabpanel"
          aria-labelledby="home-tab"
          tabindex="0"
        >
          <div id="graph-area" align="center"></div>
        </div>

        <div
          class="tab-pane fade"
          id="contact-tab-pane"
          role="tabpanel"
          aria-labelledby="contact-tab"
          tabindex="0"
        >
          <div id="station-info"></div>
        </div>
        <div
          class="tab-pane fade"
          id="profile-tab-pane"
          role="tabpanel"
          aria-labelledby="profile-tab"
          tabindex="0"
        ></div>
        <br />
        <div style="float: right">
          <i class="fa-brands fa-github"></i>
          <a href="https://github.com/blaylockbk/SynopticPy" target="_blank"
            >SynopticPy
          </a>
          |
          <a
            href="https://github.com/blaylockbk/SynopticPy/blob/main/web/timeseries.html"
            target="_blank"
            >Page Source</a
          >
        </div>
        <br /><br /><br />
        <py-terminal></py-terminal>
      </div>
    </div>

    <!-- (CONTENT TABS)  -->

    <!-- prettier-ignore -->
    <py-script>
      import js
      from pyscript import Element
      import asyncio
      from pyodide.http import pyfetch
      import matplotlib as mpl
      import matplotlib.pyplot as plt
      import pandas as pd
      import numpy as np
      import sys

      print(f"Python version:", sys.version)
      print(f"imported matplotlib {mpl.__version__}")
      print(f"imported pandas {pd.__version__}")
      print(f"imported numpy {np.__version__}")

      # Change default date formatter
      plt.rcParams["date.autoformatter.day"] = "%b %d\n%H:%M"
      plt.rcParams["date.autoformatter.hour"] = "%b %d\n%H:%M"


      mpl.rcParams['figure.figsize'] = [10,6]
      mpl.rcParams['axes.labelsize'] = 'large'
      mpl.rcParams['xtick.labelsize'] = 'medium'
      mpl.rcParams['ytick.labelsize'] = 'medium'
      mpl.rcParams['axes.titlesize'] = 'xx-large'
      mpl.rcParams['axes.facecolor'] = ".95"
      mpl.rcParams['axes.spines.left'] = False
      mpl.rcParams['axes.spines.bottom'] = False
      mpl.rcParams['axes.spines.top'] = False
      mpl.rcParams['axes.spines.right'] = False
      mpl.rcParams['xtick.major.size'] = 0
      mpl.rcParams['xtick.minor.size'] = 0
      mpl.rcParams['ytick.major.size'] = 0
      mpl.rcParams['ytick.minor.size'] = 0


      # Available API Services
      # https://developers.synopticdata.com/mesonet/v2/
      _service = {"auth", "networks", "networktypes", "variables", "qctypes"}
      _stations = {"metadata", "timeseries", "precipitation", "nearesttime", "latest"}
      _service.update(_stations)

      # Station Selector Parameters Set
      _stn_selector = {
          "stid",
          "country",
          "state",
          "country",
          "status",
          "nwszone",
          "nwsfirezone",
          "cwa",
          "gacc",
          "subgacc",
          "vars",
          "varsoperator",
          "network",
          "radius",
          "limit",
          "bbox",
          "fields",
      }


      # Rename "set_1" and "value_1" names is a convience I prefer.
      ## You can turn these off in your requests by setting `rename_set_1`
      ## and `rename_value_1` to False in your function call where applicable.
      def _rename_set_1(df):
          """
          Rename Variable Columns Names

          Remove the 'set_1' and 'set_1d' from column names
          Sets 2+ will retain their full names.
          The user should refer to SENSOR_VARIABLES to see which
          variables are derived

          """

          ## Get list of current column names
          dummy_columns = list(df.columns)

          # Remove '_set_1' and '_set_1d' from column name
          var_names = [
              "_".join(v.split("_")[:-2]) if "_set_1" in v else v for v in dummy_columns
          ]

          # Number of observations in each column
          obs_count = list(df.count())

          # Sometimes, set_1 and set_1d are both returned. In that
          # case, we need to determin which column has the most
          # observations and use that as the main variable. The set
          # with fewer data will retain the 'set_1' or 'set_1d' label.
          renames = {}
          for i, name in enumerate(var_names):
              # Determine all indices this variable type is located
              var_bool = [v.startswith(name + "_set_1") for v in dummy_columns]
              var_idx = np.where(var_bool)[0]

              if len(var_idx) == 1:
                  # This variable is only listed once. Rename with var_name
                  renames[dummy_columns[i]] = var_names[var_idx[0]]
              elif len(var_idx) > 1:
                  # This variable is listed more than once.
                  # Determine which set has the most non-NaN data and
                  # rename that column as var_name.
                  max_idx = var_idx[np.argmax([obs_count[i] for i in var_idx])]
                  if max_idx == i:
                      # If the current iteration matches the var_idx with
                      # the most data, rename the column without set number.
                      renames[dummy_columns[i]] = var_names[max_idx]
                  else:
                      # If the current iteration does not match the var_idx
                      # with the most data, then retain the original column
                      # name with the set number.
                      renames[dummy_columns[i]] = dummy_columns[i]
              else:
                  # This case should only occur during my testing.
                  renames[dummy_columns[i]] = dummy_columns[i]
          df.rename(columns=renames, inplace=True)
          df.attrs["RENAMED"] = renames
          return df


      async def request(
          url,
          method="GET",
          body=None,
          headers=None,
          **fetch_kwargs,
      ):
          """
          Async request function. Pass in Method and make sure to await!
          Parameters:
              url: str = URL to make request to
              method: str = {"GET", "POST", "PUT", "DELETE"} from `JavaScript` global fetch())
              body: str = body as json string. Example, body=json.dumps(my_dict)
              headers: dict[str, str] = header as dict, will be converted to string...
                  Example, headers=json.dumps({"Content-Type": "application/json"})
              fetch_kwargs: Any = any other keyword arguments to pass to `pyfetch` (will be passed to `fetch`)
          Return:
              response: pyodide.http.FetchResponse = use with .status or await.json(), etc.
          """
          kwargs = {
              "method": method,
              "mode": "cors",
          }  # CORS: https://en.wikipedia.org/wiki/Cross-origin_resource_sharing
          if body and method not in ["GET", "HEAD"]:
              kwargs["body"] = body
          if headers:
              kwargs["headers"] = headers
          kwargs.update(fetch_kwargs)

          response = await pyfetch(url, **kwargs)
          return response

      def clear_terminal():
        ter = js.document.getElementById("my-terminal")
        ter.innerHTML = ''


      async def main():

          # -------------------------------------------------------------------
          # Get and validate input values
          # -------------------------------------------------------------------
          stid = Element("stidInput").value.replace(" ", "").upper()
          try:
            duration = pd.to_timedelta(Element("durationInput").value)
          except:
            print("⛔ ERROR: Duration could not be parsed by Pandas. Try something like '12min', '6H', '3D' instead.")
          if duration > pd.to_timedelta("356D"):
            duration = pd.to_timedelta("356D")
            print("⚠️ WARNING: Requested too long of a dataset; setting duration to 366 days.")
          try:
            end = pd.to_datetime(Element("endTimeInput").value)
          except:
            print("⛔ ERROR: End time could not be parsed by Pandas. Use the format 'YYYY-MM-DD HH:MM' instead.")
          start = end - duration
          variable = Element("variableSelector").value
          smooth_type = Element("smootherSelector1").value
          smooth_stat = Element("smootherSelector2").value
          try:
            smooth_time = pd.to_timedelta(Element("smootherInput").value)
          except:
            print("⛔ ERROR: Duration could not be parsed by Pandas. Try something like '12min', '6H', '3D' instead.")

          for ele in js.document.getElementsByName("unitsRadioOptions"):
              if ele.checked:
                  units = ele.value
                  break

          for ele in js.document.getElementsByName("timezoneRadioOptions"):
              if ele.checked:
                  obtimezone = ele.value
                  break

          color_cycle = []
          for ele in js.document.getElementsByName("color"):
              color_cycle.append(ele.value)
              # Color cycle for plot lines

          mpl.rcParams['axes.prop_cycle'] = mpl.cycler(color=color_cycle)
          # -------------------------------------------------------------------

          print("")
          # Write input values to page
          #print("User Input")
          #print(f" ├──{stid=}")
          #print(f" ├──{duration=}")
          #print(f" ├──{start=}")
          #print(f" ├──{end=}")
          #print(f" ├──{variable=}")
          #print(f" ├──{units=}")
          #print(f" ├──{obtimezone=}")
          #print(f" ├──{smooth_type=}")
          #print(f" ├──{smooth_stat=}")
          #print(f" └──{smooth_time=}")


          #==================================================
          # If you using this page as a template,
          # PLEASE use your own token. You can
          # create a *free* Synoptic account and
          # Mesonet API token here:
          # https://developers.synopticdata.com/mesonet/
          token = "0bbe0e9fda7945a68951cc1bdebb2b0d"
          #==================================================
          if '=' in stid:
            # User used the "backdoor" to specify a new station query
            # e.g. stid="radius=wbb,10&limit=5"
            custom_query = True
            url = f"https://api.synopticdata.com/v2/stations/timeseries?start={start:%Y%m%d%H%M}&end={end:%Y%m%d%H%M}&{stid}&vars={variable}&units={units}&obtimezone={obtimezone}&token={token}"
          else:
            # User requested a comma-separated list of station IDs
            custom_query = False
            url = f"https://api.synopticdata.com/v2/stations/timeseries?start={start:%Y%m%d%H%M}&end={end:%Y%m%d%H%M}&stid={stid}&vars={variable}&units={units}&obtimezone={obtimezone}&token={token}"

          print(f"Request URL: {url.replace(token,'*****')}")

          response = await request(url, method="GET")
          status = response.status
          data = await response.json()

          if data['SUMMARY']['RESPONSE_MESSAGE'].upper() == 'OK':
            status_symbol = '✅'
          else:
            status_symbol = '❌'
          print(f"{status_symbol} GET request=> status:{status} >>> Response Message: {data['SUMMARY']['RESPONSE_MESSAGE']}. Received [{data['SUMMARY'].get('NUMBER_OF_OBJECTS')}] stations. Timer: {data['SUMMARY'].get('DATA_QUERY_TIME', 'n/a')}")

          rename_set_1 = True

          # Build a separate pandas.DataFrame for each station.
          Z = {}
          for stn in data["STATION"]:
              obs = stn.pop("OBSERVATIONS")
              senvars = stn.pop("SENSOR_VARIABLES")

              # Turn Data into a DataFrame
              df = pd.DataFrame(obs).set_index("date_time")

              # Remaining data in dict will be returned as attribute
              df.attrs = stn

              # Convert datetime index string to datetime
              df.index = pd.to_datetime(df.index)

              # Sort Column order alphabetically
              df = df.reindex(columns=df.columns.sort_values())

              # Break wind into U and V components, if speed and direction are available
              if all(["wind_speed" in senvars, "wind_direction" in senvars]):
                  for i_spd, i_dir in zip(
                      senvars["wind_speed"].keys(), senvars["wind_direction"].keys()
                  ):
                      u, v = spddir_to_uv(obs[i_spd], obs[i_dir])
                      this_set = "_".join(i_spd.split("_")[-2:])
                      df[f"wind_u_{this_set}"] = u
                      df[f"wind_v_{this_set}"] = v
                      data["UNITS"]["wind_u"] = data["UNITS"]["wind_speed"]
                      data["UNITS"]["wind_v"] = data["UNITS"]["wind_speed"]

              if rename_set_1:
                  df = _rename_set_1(df)

              # Drop Row if all data is NaN/None
              df.dropna(how="all", inplace=True)

              # In the DataFrame attributes, Convert some strings to float/int
              # (i.e., ELEVATION, latitude, longitude) BUT NOT STID!
              for k, v in df.attrs.items():
                  if isinstance(v, str) and k not in ["STID"]:
                      try:
                          n = float(v)
                          if n.is_integer():
                              df.attrs[k] = int(n)
                          else:
                              df.attrs[k] = n
                      except:
                          pass

              if len(df.columns) != len(set(df.columns)):
                  warnings.warn("🤹🏼‍♂️ DataFrame contains duplicate column names.")

              # Rename lat/lon to lowercase to match CF convenctions
              df.attrs["latitude"] = df.attrs.pop("LATITUDE")
              df.attrs["longitude"] = df.attrs.pop("LONGITUDE")

              # Include other info
              for i in data.keys():
                  if i != "STATION":
                      df.attrs[i] = data[i]
              df.attrs["SENSOR_VARIABLES"] = senvars
              #df.attrs["params"] = params
              df.attrs["service"] = "stations_timeseries"

              Z[df.attrs["STID"]] = df

          if not custom_query:
            # Sort stations in order they were requested
            Z = {i: Z[i] for i in stid.split(",") if i in Z.keys()}

          fig, ax = plt.subplots()

          station_info = ""
          for STID, df in Z.items():

              try:
                if smooth_type == "rolling" and smooth_stat.lower() != 'none':
                  preserve_attrs = df.attrs
                  print(f"Apply smoothing:{smooth_type=}; {smooth_stat=}; {smooth_time=}")
                  df = getattr(df.rolling(smooth_time), smooth_stat)()
                  df.attrs = preserve_attrs
                elif smooth_type == "resample" and smooth_stat.lower() != 'none':
                  print(f"Apply smoothing:{smooth_type=}; {smooth_stat=}; {smooth_time=}")
                  df = getattr(df.resample(smooth_time, label='right'), smooth_stat)()

                ax.plot(df.index, df[variable], marker='o', markersize=3, linestyle='-', label=STID)
                mesowest = f"""<a href="https://mesowest.utah.edu/cgi-bin/droman/meso_base_dyn.cgi?stn={df.attrs['STID']}" target="_blank">MesoWest</a>"""
                station_info += f"<br><h3>{df.attrs['STID']} - {df.attrs['NAME']} {mesowest}</h3>{pd.DataFrame(pd.Series(df.attrs)).rename(columns={0:''}).to_html(classes='table table-striped table-sm')}<br>"
              except Exception as e:
                print(f"⛔ ERROR: {e}")
                print(df)
          Element("station-info").element.innerHTML = station_info

          var_label = variable.replace("_", " ").title()
          if var_label.lower() == 'air temp':
            var_label = 'Air Temperature'

          ax.text(1.0, 0.0, f'{obtimezone.upper()} ', transform=ax.transAxes, va='bottom', ha='right')
          ax.set_ylabel(f'{var_label} ({df.attrs.get("UNITS").get(variable)})')
          ax.set_title(var_label)


          ax.spines[['right', 'top', 'bottom']].set_visible(False)
          ax.legend()
          ax.grid(color='w', linewidth=2, alpha=.8)
          plt.tight_layout()
          display(fig, target="graph-area", append=False)

      asyncio.ensure_future(main())

    </py-script>
    <style>
      img {
        max-width: 98%;
        align-items: center;
      }
    </style>
  </body>
</html>
