<!DOCTYPE html>
<html data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Station Timeseries</title>
    <link
      rel="icon"
      type="image/jpeg"
      href="https://raw.githubusercontent.com/blaylockbk/SynopticPy/main/images/Balloon_logo/square_balloon.jpg"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous"
    />
    <script
      src="https://kit.fontawesome.com/f6cc126dcc.js"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />

    <!-- Comment this line to turn off loading pyscript (only render page) -->
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <style>
      .spaced-list li {
        margin-bottom: 10px; /* Increase the margin-bottom value to increase spacing */
      }
    </style>
  </head>

  <body>
    <!-- prettier-ignore -->
    <py-config>
      packages = ["matplotlib", "pandas", "numpy", "scipy"]
      [[fetch]]
        files = ["./timeseries.py"]
    </py-config>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
      crossorigin="anonymous"
    ></script>

    <script>
      // If Smoother method selector is none, then disable the interval and stat input,
      // but if user selects a smoother, then activate the interval and stat inputs.
      function checkInputValue() {
        var input1Value = document.getElementById("smootherSelector1").value;
        var input2 = document.getElementById("smootherInput");
        var input3 = document.getElementById("smootherSelector2");

        if (input1Value === "none") {
          input2.disabled = true;
          input3.disabled = true;
        } else {
          input2.disabled = false;
          input3.disabled = false;
        }
      }
    </script>

    <!-- NAVBAR -->
    <nav
      class="navbar bg-body-tertiary border-bottom border-bottom-dark"
      data-bs-theme="dark"
    >
      <div class="container-fluid">
        <!-- Left Menu -->
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarTogglerDemo03"
          aria-controls="navbarTogglerDemo03"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a
                class="nav-link active"
                aria-current="page"
                href="meteogram.html"
                >Meteogram</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Placeholder Link</a>
            </li>
          </ul>
        </div>
        <!-- Title -->
        <a class="navbar-brand"
          ><h2 style="display: inline">Station Timeseries</h2></a
        >
        <!-- README button; trigger modal -->
        <button
          type="button"
          class="btn btn-outline-info"
          data-bs-toggle="modal"
          data-bs-target="#exampleModal"
        >
          README
        </button>
      </div>
    </nav>

    <!-- Modal Content -->
    <div
      class="modal fade"
      id="exampleModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">
              Brian Blaylock's Station Timeseries Web App
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" style="font-size: 15px; text-align: left">
            This station timeseries app is used to plot data from one or more
            weather stations on the same figure. It gets data from the Synoptic
            Mesonet API, reads it with Pandas, and plots a timeseries of the
            data with matplotlib. This is all done in your browser powered by
            <a href="https://pyscript.net/">pyscript</a>.

            <hr />
            <strong>Token:</strong>
            You may insert your own
            <a
              href="https://developers.synopticdata.com/mesonet/v2/getting-started/"
              target="_blank"
              >Synoptic API token</a
            >
            below. If left blank, you will use one of my free-tier tokens
            <i
              >which may be limited if more than 4+ people are using this page
              at the same time</i
            >. Using your own token prevents running into this problem and gives
            you access to features you may have for your account.
            <div class="input-group mb-3">
              <span class="input-group-text" id="token">Token</span>
              <input
                type="text"
                id="tokenInput"
                class="form-control"
                placeholder="Synoptic API Token"
              />
            </div>

            <hr />
            <strong>Stations:</strong> A comma-separated list of station IDs,
            e.g. <kbd>PSRIM,PSINK</kbd>. If you don't know the station ID, you
            can search on
            <a href="https://mesowest.utah.edu/" target="_blank">Mesowest</a>.
            Open the dropdown for more advanced station selection.

            <div class="accordion" id="accordionExample">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseThree"
                    aria-expanded="false"
                    aria-controls="collapseThree"
                  >
                    Backdoor: Advanced Station Selector
                  </button>
                </h2>
                <div
                  id="collapseThree"
                  class="accordion-collapse collapse"
                  data-bs-parent="#accordionExample"
                >
                  <div class="accordion-body">
                    <p>
                      With some knowledge of the Synoptic Mesonet API, you can
                      make more complex station queries. Instead of a list of
                      stations, you can instead provide
                      <a
                        target="_blank"
                        href="https://developers.synopticdata.com/mesonet/v2/stations/timeseries/"
                        >station selection parameters</a
                      >
                      to refine your station selection. This string is inserted
                      in the API request, so you need to separate each argument
                      with a
                      <code>&</code>. For example:
                    </p>

                    <ul class="spaced-list">
                      <li>
                        <kbd>radius=wbb,5</kbd> All stations within a 5 mile
                        radius of <code>WBB</code>.
                      </li>
                      <li>
                        <kbd>radius=wbb,5&limit=10</kbd>
                        <code>10</code> stations nearest <code>WBB</code> within
                        a <code>5</code> mile radius.
                      </li>
                      <li>
                        <kbd>radius=WBB,5&limit=10&stid=!MTMET</kbd> Same as
                        above, but exclude the station <code>MTMET</code>.
                      </li>
                      <li>
                        <kbd>radius=WBB,20&network=153</kbd> Stations within
                        <code>20</code> miles of <code>WBB</code> that belong to
                        the <code>UUNET</code> network. (See list of
                        <a
                          href="https://developers.synopticdata.com/about/station-providers/"
                          >network providers</a
                        >.)
                      </li>
                      <li>
                        <kbd>radius=KSLC,40&network=1,2&limit=8</kbd>
                        <code>8</code> stations within <code>40</code> miles of
                        <code>KSLC</code> that belong to the
                        <code>ASOS/AWOS</code> and <code>RAWS</code> networks.
                        (See list of
                        <a
                          href="https://developers.synopticdata.com/about/station-providers/"
                          >network providers</a
                        >.)
                      </li>
                      <li>
                        <kbd>radius=41.5,-120.25,20&limit=10</kbd>
                        <code>10</code> stations within <code>20</code> miles of
                        the <code>latitude,longitude</code>
                        location.
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            <br />

            <hr />
            <strong>Variable:</strong> Select the variable you wish to plot.

            <hr />
            <strong>Start and End Datetime:</strong>
            There are three ways to specify the plot's time range:
            <ol>
              <li>
                "Start at <code>[datetime]</code> and end at
                <code>[datetime]</code>."
              </li>
              <li>
                "Start at <code>[datetime]</code> and end
                <code>[timedelta]</code> later."
              </li>
              <li>
                "Start <code>[timedelta]</code> before the end
                <code>[datetime]</code>."
              </li>
            </ol>

            <strong>Start Time:</strong> Specify the starting time for the plot.
            This must be a Pandas-parsable datetime string
            <kbd>YYYY-MM-DD HH:MM</kbd> <i>or</i> if an End datetime is given, a
            Pandas-parsable timedelta such as <kbd>30min</kbd> for 30 minutes,
            <kbd>12H</kbd> for 12 hours, <kbd>3D</kbd> for 3 days.
            <br />
            <br />
            <strong>End Time:</strong> Specify the ending time for the plot.
            This must be a Pandas-parsable datetime string
            <kbd>YYYY-MM-DD HH:MM</kbd> <i>or</i> if a Start datetime is given,
            a Pandas-parsable timedelta such as <kbd>30min</kbd> for 30 minutes,
            <kbd>12H</kbd> for 12 hours, <kbd>3D</kbd> for 3 days.
            <hr />
            <strong>Smoother:</strong>
            You can "smooth" the data using two different methods built into
            Pandas:

            <ol>
              <li>
                <a
                  href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.resample.html"
                  target="_blank"
                  >Resample</a
                >: Reduces the amount of data points to interval selected by
                computing a statistic for the time window. This is useful for
                showing the "daily maximum temperature" for the time period.
              </li>
              <li>
                <a
                  href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.rolling.html"
                  target="_blank"
                  >Rolling</a
                >: Returns the same amount of data points but value (i.e. mean,
                max, min) is computed over a rolling time window.
              </li>
            </ol>
            Also specify the time window (as a Pandas-parsable timedelta) and
            the statistic to compute in the time window (e.g. Mean). Note: wind
            direction statistics uses
            <a
              ref="https://docs.scipy.org/doc/scipy/reference/stats.html#directional-statistical-functions"
              >SciPy Directional Statistics</a
            >. Also, "Spread" is a special case that is intended to be used with
            the "Resample" method; it shows a bar of the max, min, median, and a
            diamond for the mean within the Resample time window.

            <hr />
            <strong>Colors:</strong>
            Specify the colors you want each line. Maybe you have lots of
            stations plotted, but want to highlight only one; you can make that
            station "red" and the others a shade of grey. Note that colors are
            reused if there are more stations than colors.

            <hr />
            <strong>Toggles:</strong>
            Toggle units to be returned in English or Metric units. Also toggle
            if time is local or UTC.
          </div>
          <div class="modal-footer">
            <div style="font-size: 12px">
              <i class="fa-brands fa-github"></i>
              <a href="https://github.com/blaylockbk/SynopticPy" target="_blank"
                >SynopticPy </a
              >|
              <a
                href="https://github.com/blaylockbk/SynopticPy/issues"
                target="_blank"
                >Submit Issue</a
              >|
              <a
                href="https://github.com/blaylockbk/SynopticPy/discussions"
                target="_blank"
                >Ask Question</a
              >|

              <a
                href="https://github.com/blaylockbk/SynopticPy/blob/main/web/timeseries.html"
                target="_blank"
                >Edit Page</a
              >|
              <a
                href="https://github.com/blaylockbk/SynopticPy/blob/main/web/timeseries.py"
                target="_blank"
                >Edit Plot</a
              >
              <br />
            </div>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <br />
      <div align="center" class="contentText form-group">
        <!-- FIRST ROW -->
        <div class="row align-items-center">
          <div class="col-sm-6">
            <!-- Station Selector ----------------------->
            <div class="input-group mb-3">
              <!-- <button type="button" class="btn"><i class="fa-regular fa-circle-question"></i></button> -->
              <span class="input-group-text" id="stid">Stations</span>
              <input
                type="text"
                id="stidInput"
                spellcheck="false"
                class="form-control"
                value="PSRIM,PSINK"
                title="Comma-separated list of Station IDs or Synoptic API Station Selector string"
              />
            </div>
          </div>
          <div class="col-sm-6">
            <!-- Variable ----------------------->
            <!-- prettier-ignore -->
            <div class="input-group mb-3">
              <label class="input-group-text" for="variable">Variable</label>
              <select class="form-select" id="variableSelector">
                <option disabled style="font-size: 0.5em"></option>
                <option selected="selected" value="air_temp">🌡️ Air Temperature</option>

                <option disabled style="font-size: 0.5em"></option>
                <option value="relative_humidity">💧 Relative Humidity</option>
                <option value="dew_point_temperature">💦 Dew Point</option>

                <option disabled style="font-size: 0.5em"></option>
                <option value="wind_speed">🍃 Wind Speed</option>
                <option value="wind_direction">🧭 Wind Direction</option>
                <option value="wind_gust">🌬️ Wind Gust</option>
                <option value="wind_direction,wind_speed" disabled>🏹 Wind Barbs</option>

                <option disabled style="font-size: 0.5em"></option>
                <option value="precip">☔ Accumulated Precipitation</option>
                <option value="snow_depth">❄️ Snow Depth</option>

                <option disabled style="font-size: 0.5em"></option>
                <option value="pressure">🎈 Pressure</option>
                <option value="altimeter">🏔️ Altimeter</option>
                <option value="sea_level_pressure">⛵ Sea Level Pressure</option>

                <option disabled style="font-size: 0.5em"></option>
                <option value="solar_radiation">☀️ Solar Radiation</option>
                <option value="volt">🔋 Battery Voltage</option>

                <option disabled style="font-size: 0.5em"></option>
                <option value="PM_25_concentration">🏭 PM 2.5 Concentration</option>
                <option value="ozone_concentration">😎 Ozone Concentration</option>
              </select>
            </div>
          </div>
        </div>
        <!-- SECOND ROW -->
        <div class="row align-items-center">
          <div class="col-sm-6">
            <!-- Start Time ----------------------->
            <div class="input-group mb-3">
              <span class="input-group-text" id="startTime"
                >Start time (UTC)</span
              >
              <input
                type="text"
                id="startTimeInput"
                class="form-control"
                spellcheck="false"
                value="18H"
                title="Pandas-parsable datetime (e.g., YYYY-MM-DD HH:MM) or timedelta (e.g., 30min, 1H, 6H)"
              />
            </div>
          </div>
          <div class="col-sm-6">
            <!-- End Time ----------------------->
            <div class="input-group mb-3">
              <span class="input-group-text" id="endTime">End time (UTC)</span>
              <input
                type="text"
                class="form-control"
                spellcheck="false"
                id="endTimeInput"
                placeholder="YYYY-MM-DD HH:MM"
                title="Pandas-parsable datetime (e.g., YYYY-MM-DD HH:MM) or timedelta (e.g., 30min, 1H, 6H)"
              />
            </div>
            <script>
              // Get the input element by ID
              var endTimeInput = document.getElementById("endTimeInput");

              // Create a new Date object with the current datetime
              var currentDate = new Date();

              // Format the datetime as YYYY-MM-DD HH:MM
              var formattedDatetime = currentDate
                .toISOString()
                .slice(0, 16)
                .replace("T", " ");

              // Set the formatted datetime as the value of the input element
              endTimeInput.value = formattedDatetime;
            </script>
          </div>
        </div>

        <!-- FOURTH ROW -->
        <div class="row align-items-center">
          <div class="col-sm-6">
            <!-- Smoother ----------------------->
            <div class="input-group mb-3">
              <div class="input-group mb-3">
                <label class="input-group-text" for="smoothing">Smoother</label>
                <select
                  class="form-select"
                  id="smootherSelector1"
                  onchange="checkInputValue()"
                >
                  <option selected="selected" value="none">None</option>
                  <option value="resample">Resample</option>
                  <option value="rolling">Rolling</option>
                </select>
                <input
                  type="text"
                  id="smootherInput"
                  class="form-control"
                  value="30min"
                  title="Pandas-parsable timedelta (e.g., 30min, 1H, 6H)"
                  disabled
                />
                <select class="form-select" id="smootherSelector2" disabled>
                  <option selected="selected" value="mean">Mean</option>
                  <option value="max">Max</option>
                  <option value="min">Min</option>
                  <option value="median">Median</option>
                  <option value="std">Standard Deviation</option>
                  <option value="var">Variance</option>
                  <option value="count">Count</option>
                  <option value="spread">Spread</option>
                </select>
              </div>
            </div>
          </div>
          <div class="col-sm-6">
            <!-- Colors ----------------------->
            <!-- prettier-ignore -->
            <div class="input-group mb-3">
              <label class="input-group-text" for="colorCycle"
                >Colors</label
              >
              <input type="color" class="form-control form-control-color" name="color" value="#0d6efd" title="Choose color" id="color1">
              <input type="color" class="form-control form-control-color" name="color" value="#dc3545" title="Choose color" id="color2">
              <input type="color" class="form-control form-control-color" name="color" value="#fd7e14" title="Choose color" id="color3">
              <input type="color" class="form-control form-control-color" name="color" value="#198754" title="Choose color" id="color4">
              <input type="color" class="form-control form-control-color" name="color" value="#0dcaf0" title="Choose color" id="color5">
              <input type="color" class="form-control form-control-color" name="color" value="#563d7c" title="Choose color" id="color6">
              <input type="color" class="form-control form-control-color" name="color" value="#ffc107" title="Choose color" id="color7">
              <input type="color" class="form-control form-control-color" name="color" value="#262626" title="Choose color" id="color8">
              <input type="color" class="form-control form-control-color" name="color" value="#6610f2" title="Choose color" id="color9">
              <input type="color" class="form-control form-control-color" name="color" value="#20c997" title="Choose color" id="color10">
              <input type="color" class="form-control form-control-color" name="color" value="#e83e8c" title="Choose color" id="color11">
              <input type="color" class="form-control form-control-color" name="color" value="#a64dff" title="Choose color" id="color12">
            </div>
          </div>
        </div>
        <!-- THIRD ROW -->
        <div class="row align-items-center">
          <!-- Units toggle----------------------->
          <div class="col-sm-3">
            <div class="input-group mb-3">
              <div class="btn-group" role="group" aria-label="Basic example">
                <input
                  type="radio"
                  class="btn-check"
                  name="unitsRadioOptions"
                  id="unitsRadio1"
                  autocomplete="off"
                  value="english"
                  checked
                />
                <label class="btn btn-outline-dark btn-sm" for="unitsRadio1"
                  >English Units</label
                >
                <input
                  type="radio"
                  class="btn-check"
                  name="unitsRadioOptions"
                  id="unitsRadio2"
                  autocomplete="off"
                  value="metric"
                />
                <label class="btn btn-outline-dark btn-sm" for="unitsRadio2"
                  >Metric Units</label
                >
              </div>
            </div>
          </div>
          <!-- (Units toggle) -->
          <!-- timezone toggle----------------------->
          <div class="col-sm-3">
            <div class="input-group mb-3">
              <div class="btn-group" role="group" aria-label="Basic example">
                <input
                  type="radio"
                  class="btn-check"
                  name="timezoneRadioOptions"
                  id="timezoneRadio1"
                  autocomplete="off"
                  value="local"
                  checked
                />
                <label class="btn btn-outline-dark btn-sm" for="timezoneRadio1"
                  >Local Time</label
                >
                <input
                  type="radio"
                  class="btn-check"
                  name="timezoneRadioOptions"
                  id="timezoneRadio2"
                  autocomplete="off"
                  value="utc"
                />
                <label class="btn btn-outline-dark btn-sm" for="timezoneRadio2"
                  >UTC Time</label
                >
              </div>
            </div>
          </div>
          <!-- (timezone toggle) -->
          <div class="col-sm-6">
            <!-- Submit Button -->
            <div class="form-group" style="padding-top: 10px">
              <div class="d-grid gap-2 col-6 mx-auto">
                <button
                  type="submit"
                  class="btn btn-success btn-lg"
                  py-click="main(display)"
                  id="display"
                >
                  Make Plot
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <hr />

      <!-- CONTENT TABS  -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="timeseries-tab"
            data-bs-toggle="tab"
            data-bs-target="#timeseries-tab-pane"
            type="button"
            role="tab"
            aria-controls="timeseries-tab-pane"
            aria-selected="true"
          >
            Timeseries
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="map-tab"
            data-bs-toggle="tab"
            data-bs-target="#map-tab-pane"
            type="button"
            role="tab"
            aria-controls="map-tab-pane"
            aria-selected="false"
          >
            Map
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="station-tab"
            data-bs-toggle="tab"
            data-bs-target="#station-tab-pane"
            type="button"
            role="tab"
            aria-controls="station-tab-pane"
            aria-selected="false"
          >
            Station Info
          </button>
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <!-- Timeseries Figure Tab -->
        <div
          class="tab-pane fade show active"
          id="timeseries-tab-pane"
          role="tabpanel"
          aria-labelledby="timeseries-tab"
          tabindex="0"
        >
          <div id="figure-timeseries" align="center"></div>
        </div>

        <!-- Map Figure Tab -->
        <div
          class="tab-pane fade"
          id="map-tab-pane"
          role="tabpanel"
          aria-labelledby="map-tab"
          tabindex="0"
        >
          <div id="figure-map" align="center"></div>
        </div>

        <!-- Station Info Tab -->
        <div
          class="tab-pane fade"
          id="station-tab-pane"
          role="tabpanel"
          aria-labelledby="station-tab"
          tabindex="0"
        >
          <div id="station-info"></div>
        </div>
      </div>
      <!-- (CONTENT TABS)  -->

      <!-- Bottom material -->
      <br />
      <hr />
      <div style="float: left">
        <div id="json-download"></div>
      </div>
      <div style="float: right">
        <i class="fa-brands fa-github"></i>
        <a href="https://github.com/blaylockbk/SynopticPy" target="_blank"
          >SynopticPy
        </a>
      </div>
      <br /><br /><br />
      <py-terminal></py-terminal>
    </div>

    <!-- prettier-ignore -->
    <py-script>
      from timeseries import main
      print()
      print("Making new API request...")
      fig = main(display)

    </py-script>

    <style>
      img {
        max-width: 98%;
        align-items: center;
      }
    </style>
  </body>
</html>
